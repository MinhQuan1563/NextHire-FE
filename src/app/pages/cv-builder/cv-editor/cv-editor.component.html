<!-- Toast Messages for Validation and Export -->
<p-toast position="top-right" [life]="5000"></p-toast>

<!-- Loading Overlay -->
@if (isLoading()) {
  <div class="loading-overlay">
    <div class="loading-content">
      <p-progressSpinner 
        [style]="{width: '50px', height: '50px'}" 
        strokeWidth="4"
        animationDuration=".5s">
      </p-progressSpinner>
      <p class="loading-text mt-4">Đang tải template...</p>
    </div>
  </div>
}

<div class="cv-builder-container" [class.loading-blur]="isLoading()">
  <!-- Left Sidebar -->
  <div class="sidebar">
    <!-- Tab Navigation -->
    <app-sidebar-tabs
      [activeTab]="activeTab"
      (activeTabChange)="setActiveTab($event)"
    >
    </app-sidebar-tabs>

    <!-- Tab Content Panels -->
    <div class="tab-content">
      <!-- Design & Font Panel -->
      <app-design-panel
        *ngIf="activeTab === 'design'"
        [settings]="designSettings"
      >
      </app-design-panel>
      <!-- Layout Panel -->
      <app-layout-panel
        *ngIf="activeTab === 'layout'"
        [layoutConfiguration]="layoutConfiguration"
        [allSections]="allSections"
        [usedSections]="usedSections"
        [availableSections]="availableLayoutSections"
        (layoutChange)="onLayoutChange($event)"
      >
      </app-layout-panel>
    </div>
  </div>
  <!-- Main CV Preview Area -->
  <div class="main-content">
    <!-- Header with Management Button -->
    <div class="cv-editor-header">
      <div class="header-left">
        <h1>CV Editor</h1>
        <p>Tạo và chỉnh sửa CV của bạn</p>
      </div>
      <div class="header-actions">
        @if (isAdmin()) {
          <p-button 
            class="btn-manage-categories" 
            (click)="openSectionManagementModal()"
            [disabled]="isSaving()"
          >
            <span>Quản lý danh mục</span>
          </p-button>
          <p-button 
            class="btn-layout-manage"
            (click)="openLayoutManagementModal()"
            [disabled]="isSaving()"
          >
            <span>Quản lý Layout</span>
          </p-button>
          <p-button 
            class="btn-save-template" 
            (click)="openSaveTemplateDialog()"
            [disabled]="isSaving()"
            [loading]="isSaving()"
          >
            <span>{{ isSaving() ? 'Đang lưu...' : 'Lưu' }}</span>
          </p-button>
        }
      </div>
    </div>
    <!-- Edit Toolbar -->
    <app-edit-toolbar
      [show]="showEditToolbar"
      [position]="editToolbarPosition"
    >
    </app-edit-toolbar>

    <!-- CV Preview -->
    <app-cv-preview
      [layoutConfiguration]="layoutConfiguration"
      [allSections]="allSections"
      [usedSections]="usedSections"
      [designSettings]="designSettings"
      [isZoomed]="isZoomed"
      (editableClick)="onEditableClick($event.event, $event.fieldName)"
      (zoomToggle)="zoomCV()"
      (download)="downloadCV()"
    >
    </app-cv-preview>
  </div>
</div>

<!-- Section Management Modal -->
<p-dialog
  draggable="false"
  header="Quản Lý Sections"
  [modal]="true"
  [(visible)]="showManagementModal"
  [maximizable]="true"
  [style]="{width: '90vw', height: '80vh'}"
  [contentStyle]="{height: 'calc(100% - 60px)', overflow: 'hidden'}"
  styleClass="section-management-modal">

  <app-manage-section></app-manage-section>

</p-dialog>
<!-- Layout Management Modal -->
<p-dialog
  draggable="false"
  header="Quản Lý Layout"
  [modal]="true"
  [(visible)]="showLayoutConfigModal"
  [maximizable]="true"
  [style]="{width: '80vw', height: '70vh'}"
  [contentStyle]="{height: 'calc(100% - 60px)'}"
  styleClass="layout-management-modal">

  <app-layout-config-modal
    (close)="closeLayoutManagementModal()"
    (save)="closeLayoutManagementModal()"
  >
  </app-layout-config-modal>

</p-dialog>

<!-- Save Template Dialog -->
<app-save-template-dialog
  [visible]="showSaveTemplateDialog"
  [templateName]="cvTemplateStore.template().name || ''"
  [templateDescription]="cvTemplateStore.template().description || ''"
  [templateType]="cvTemplateStore.template().type || 0"
  (onClose)="closeSaveTemplateDialog()"
  (onSave)="onSaveTemplateData($event)"
>
</app-save-template-dialog>
