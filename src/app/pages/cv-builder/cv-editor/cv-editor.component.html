<div class="cv-builder-container">
  <!-- Left Sidebar -->
  <div class="sidebar">
    <!-- Tab Navigation -->
    <app-sidebar-tabs
      [activeTab]="activeTab"
      (activeTabChange)="setActiveTab($event)"
    >
    </app-sidebar-tabs>

    <!-- Tab Content Panels -->
    <div class="tab-content">
      <!-- Design & Font Panel -->
      <app-design-panel
        *ngIf="activeTab === 'design'"
        [settings]="designSettings"
        (fontChange)="onFontChange($event)"
        (fontSizeChange)="onFontSizeChange($event)"
        (lineSpacingChange)="onLineSpacingChange($event)"
        (colorChange)="onColorChange($event)"
        (colorPickerChange)="onColorPickerChange($event)"
        (backgroundChange)="onBackgroundChange($event)"
      >
      </app-design-panel>

      <!-- Add Sections Panel -->
      <app-sections-panel
        *ngIf="activeTab === 'sections'"
        [availableSections]="getUnusedSections()"
        (sectionAdd)="addSectionToLayout($event)"
      >
      </app-sections-panel>

      <!-- Layout Panel -->
      <app-layout-panel
        *ngIf="activeTab === 'layout'"
        [usedSections]="usedSections"
        (sectionRemove)="removeSection($event)"
        (sectionsReorder)="reorderSections($event)"
        (dragStart)="onDragStart($event.event, $event.section)"
        (drop)="onDrop($event.event, $event.targetSection)"
      >
      </app-layout-panel>
    </div>
  </div>

  <!-- Main CV Preview Area -->
  <div class="main-content">
    <!-- Header with Management Button -->
    <div class="cv-editor-header">
      <div class="header-left">
        <h1>CV Editor</h1>
        <p>T·∫°o v√† ch·ªânh s·ª≠a CV c·ªßa b·∫°n</p>
      </div>
      <div class="header-actions">
        <button class="btn-manage-categories" (click)="openManagementModal()">
          <i class="icon-settings">‚öôÔ∏è</i>
          <span>Qu·∫£n l√Ω danh m·ª•c</span>
        </button>
        <button class="btn-layout-config" (click)="openLayoutConfigModal()">
          <i class="icon-layout">üé®</i>
          <span>C·∫•u h√¨nh Layout</span>
        </button>
        <button 
          class="btn-layout-manage" 
          (click)="openLayoutManagementModal()"
          [disabled]="false"
        >
          <i class="icon-grid">üìê</i>
          <span>Qu·∫£n l√Ω Layout</span>
        </button>
      </div>
    </div>

    <!-- Edit Toolbar -->
    <app-edit-toolbar
      [show]="showEditToolbar"
      [position]="editToolbarPosition"
      (hide)="hideEditToolbar()"
      (bold)="makeBold()"
      (italic)="makeItalic()"
      (underline)="makeUnderline()"
      (bulletList)="createBulletList()"
      (numberList)="createNumberList()"
      (fontSizeChange)="changeFontSize($event.toString())"
      (alignLeft)="alignLeft()"
      (alignCenter)="alignCenter()"
      (alignRight)="alignRight()"
      (alignJustify)="alignJustify()"
    >
    </app-edit-toolbar>

    <!-- CV Preview -->
    <app-cv-preview
      #fileInput
      [cvData]="cvData"
      [usedSections]="usedSections"
      [designSettings]="designSettings"
      [selectedAvatarUrl]="selectedAvatarUrl"
      [isZoomed]="isZoomed"
      (fileSelected)="onFileSelected($event)"
      (fieldUpdate)="updateField($event.fieldName, $event.event)"
      (editableClick)="onEditableClick($event.event, $event.fieldName)"
      (zoomToggle)="zoomCV()"
      (download)="downloadCV()"
      (experienceAdd)="addExperience()"
      (experienceRemove)="removeExperience($event)"
      (responsibilityAdd)="addResponsibility($event)"
      (responsibilityRemove)="removeResponsibility($event)"
    >
    </app-cv-preview>
  </div>
</div>

<!-- Category Modal -->
<div *ngIf="showCategoryModal" class="modal-overlay" (click)="closeCategoryModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>{{ modalMode === 'add' ? 'Th√™m danh m·ª•c m·ªõi' : 'Ch·ªânh s·ª≠a danh m·ª•c' }}</h3>
      <button class="modal-close" (click)="closeCategoryModal()">‚úï</button>
    </div>
    
    <div class="modal-body">
      <div class="form-group">
        <label for="categoryName">T√™n danh m·ª•c *</label>
        <input 
          id="categoryName"
          type="text" 
          [(ngModel)]="newCategoryForm.name"
          placeholder="Nh·∫≠p t√™n danh m·ª•c"
          class="form-input"
          required
        />
      </div>
      
      <div class="form-group">
        <label for="categoryIcon">Icon</label>
        <input 
          id="categoryIcon"
          type="text" 
          [(ngModel)]="newCategoryForm.icon"
          placeholder="Ch·ªçn emoji (vd: üìÅ)"
          class="form-input"
        />
        <small class="form-help">S·ª≠ d·ª•ng emoji l√†m icon cho danh m·ª•c</small>
      </div>
      
      <div class="form-group">
        <label for="categoryDescription">M√¥ t·∫£</label>
        <textarea 
          id="categoryDescription"
          [(ngModel)]="newCategoryForm.description"
          placeholder="M√¥ t·∫£ ng·∫Øn g·ªçn v·ªÅ danh m·ª•c"
          class="form-textarea"
          rows="3"
        ></textarea>
      </div>
      
      <div class="form-group">
        <label class="checkbox-label">
          <input 
            type="checkbox" 
            [(ngModel)]="newCategoryForm.allowMultiple"
          />
          <span class="checkmark"></span>
          Cho ph√©p th√™m nhi·ªÅu m·ª•c c√πng lo·∫°i
        </label>
        <small class="form-help">N·∫øu b·∫≠t, ng∆∞·ªùi d√πng c√≥ th·ªÉ th√™m nhi·ªÅu m·ª•c trong danh m·ª•c n√†y</small>
      </div>
    </div>
    
    <div class="modal-footer">
      <button class="btn btn-secondary" (click)="closeCategoryModal()">
        H·ªßy
      </button>
      <button 
        class="btn btn-primary" 
        (click)="modalMode === 'add' ? addCategory() : updateCategory()"
        [disabled]="!newCategoryForm.name.trim()"
      >
        {{ modalMode === 'add' ? 'Th√™m danh m·ª•c' : 'C·∫≠p nh·∫≠t' }}
      </button>
    </div>
  </div>
</div>

<!-- Section Modal -->
<div *ngIf="showSectionModal" class="modal-overlay" (click)="closeSectionModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>{{ modalMode === 'add' ? 'Th√™m m·ª•c m·ªõi' : 'Ch·ªânh s·ª≠a m·ª•c' }}</h3>
      <button class="modal-close" (click)="closeSectionModal()">‚úï</button>
    </div>
    
    <div class="modal-body">
      <div class="form-group">
        <label for="sectionName">T√™n m·ª•c *</label>
        <input 
          id="sectionName"
          type="text" 
          [(ngModel)]="newSectionForm.name"
          placeholder="Nh·∫≠p t√™n m·ª•c"
          class="form-input"
          required
        />
      </div>
      
      <div class="form-group">
        <label for="sectionIcon">Icon</label>
        <input 
          id="sectionIcon"
          type="text" 
          [(ngModel)]="newSectionForm.icon"
          placeholder="Ch·ªçn emoji (vd: üìÑ)"
          class="form-input"
        />
        <small class="form-help">S·ª≠ d·ª•ng emoji l√†m icon cho m·ª•c</small>
      </div>
      
      <div class="form-group">
        <label class="checkbox-label">
          <input 
            type="checkbox" 
            [(ngModel)]="newSectionForm.allowMultiple"
          />
          <span class="checkmark"></span>
          Cho ph√©p nhi·ªÅu instance
        </label>
        <small class="form-help">N·∫øu b·∫≠t, c√≥ th·ªÉ th√™m nhi·ªÅu instance c·ªßa m·ª•c n√†y v√†o CV</small>
      </div>
    </div>
    
    <div class="modal-footer">
      <button class="btn btn-secondary" (click)="closeSectionModal()">
        H·ªßy
      </button>
      <button 
        class="btn btn-primary" 
        (click)="modalMode === 'add' ? addSectionToCategory() : updateSection()"
        [disabled]="!newSectionForm.name.trim()"
      >
        {{ modalMode === 'add' ? 'Th√™m m·ª•c' : 'C·∫≠p nh·∫≠t' }}
      </button>
    </div>
  </div>
</div>

<!-- Category Management Modal -->
<div *ngIf="showManagementModal" class="modal-overlay large" (click)="closeManagementModal()">
  <div class="modal-content large" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>Qu·∫£n l√Ω danh m·ª•c CV</h3>
      <button class="modal-close" (click)="closeManagementModal()">‚úï</button>
    </div>
    
    <div class="modal-body large">
      <!-- Header Actions -->
      <div class="management-header">
        <div class="header-info">
          <p class="description">Qu·∫£n l√Ω c√°c danh m·ª•c v√† section cho CV c·ªßa b·∫°n</p>
          <div class="stats">
            <span class="stat-item">
              <strong>{{ categories.length }}</strong> danh m·ª•c
            </span>
            <span class="stat-item">
              <strong>{{ getTotalSections() }}</strong> section
            </span>
          </div>
        </div>
        <button class="btn-primary" (click)="openCategoryModal('add')">
          <i class="icon-plus">‚ûï</i>
          Th√™m danh m·ª•c m·ªõi
        </button>
      </div>

      <!-- Categories Grid -->
      <div class="categories-grid">
        <div *ngIf="categories.length === 0" class="empty-state">
          <div class="empty-icon">üìÅ</div>
          <h4>Ch∆∞a c√≥ danh m·ª•c n√†o</h4>
          <p>B·∫Øt ƒë·∫ßu b·∫±ng c√°ch t·∫°o danh m·ª•c ƒë·∫ßu ti√™n cho CV c·ªßa b·∫°n</p>
          <button class="btn-primary" (click)="openCategoryModal('add')">
            <i class="icon-plus">‚ûï</i>
            T·∫°o danh m·ª•c ƒë·∫ßu ti√™n
          </button>
        </div>
        
        <div *ngFor="let category of categories; trackBy: trackByCategory" class="category-card">
          <div class="category-header">
            <div class="category-main">
              <div class="category-icon">{{ category.icon }}</div>
              <div class="category-info">
                <h4>{{ category.name }}</h4>
                <p class="description">{{ category.description || 'Kh√¥ng c√≥ m√¥ t·∫£' }}</p>
                <div class="badges">
                  <span class="badge" [class.system]="category.isSystemCategory">
                    {{ category.isSystemCategory ? 'üîí H·ªá th·ªëng' : 'üîß T√πy ch·ªânh' }}
                  </span>
                  <span class="badge" *ngIf="category.allowMultiple">
                    üîÑ Nhi·ªÅu m·ª•c
                  </span>
                  <span class="badge count">
                    üìä {{ category.sections.length }} section
                  </span>
                </div>
              </div>
            </div>
            <div class="category-actions">
              <button 
                class="btn-action" 
                (click)="editCategory(category)"
                title="Ch·ªânh s·ª≠a danh m·ª•c"
              >
                <i>‚úèÔ∏è</i>
                S·ª≠a
              </button>
              <button 
                *ngIf="!category.isSystemCategory"
                class="btn-action danger" 
                (click)="deleteCategory(category.id)"
                title="X√≥a danh m·ª•c"
              >
                <i>üóëÔ∏è</i>
                X√≥a
              </button>
            </div>
          </div>

          <!-- Sections Management -->
          <div class="sections-container">
            <div class="sections-header">
              <h5>Sections ({{ category.sections.length }})</h5>
              <button 
                class="btn-add-section" 
                (click)="openSectionModal('add', category.id)"
                title="Th√™m section m·ªõi"
              >
                <i>+</i>
                Th√™m section
              </button>
            </div>
            
            <div class="sections-list" *ngIf="category.sections.length > 0">
              <div 
                *ngFor="let section of category.sections; trackBy: trackBySection" 
                class="section-item"
              >
                <div class="section-main">
                  <span class="section-icon">{{ section.icon }}</span>
                  <div class="section-info">
                    <span class="name">{{ section.name }}</span>
                    <span class="meta" *ngIf="section.allowMultiple">
                      üîÑ Cho ph√©p nhi·ªÅu instance
                    </span>
                  </div>
                </div>
                <div class="section-actions">
                  <button 
                    class="btn-sm" 
                    (click)="editSection(section)"
                    title="S·ª≠a section"
                  >
                    ‚úèÔ∏è
                  </button>
                  <button 
                    class="btn-sm danger" 
                    (click)="deleteSectionFromCategory(category.id, section.id)"
                    title="X√≥a section"
                  >
                    üóëÔ∏è
                  </button>
                </div>
              </div>
            </div>
            
            <div class="no-sections" *ngIf="category.sections.length === 0">
              <span class="icon">üìù</span>
              <span>Ch∆∞a c√≥ section n√†o. Th√™m section ƒë·∫ßu ti√™n!</span>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <div class="modal-footer">
      <button class="btn-secondary" (click)="closeManagementModal()">
        ƒê√≥ng
      </button>
    </div>
  </div>
</div>

<!-- Layout Configuration Modal -->
<app-layout-config-modal
  [show]="showLayoutConfigModal"
  [layoutConfig]="currentLayoutConfig"
  (close)="closeLayoutConfigModal()"
  (save)="onLayoutConfigSave($event)"
>
</app-layout-config-modal>

<!-- Layout Management Modal -->
<app-layout-management
  [show]="showLayoutManagementModal"
  [layoutConfig]="currentLayoutConfig"
  [availableSections]="availableSections"
  (close)="closeLayoutManagementModal()"
  (layoutUpdated)="onLayoutUpdated($event)"
  (sectionPlaced)="onSectionPlaced($event)"
>
</app-layout-management>
