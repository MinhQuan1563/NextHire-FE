<div class="cv-preview-area">
  <!-- Hidden file input for image uploads -->
  <input
    #fileInput
    type="file"
    accept="image/*"
    style="display: none"
    (change)="onFileSelected($event)"
  />

  <div class="preview-header">
    <h2>Xem tr∆∞·ªõc CV</h2>
    <div class="preview-actions">
      <button class="btn-secondary" (click)="zoomCV()">
        <i class="icon-zoom"></i>
        {{ isZoomed ? "Thu nh·ªè" : "Ph√≥ng to" }}
      </button>
      <button class="btn-primary" (click)="downloadCV()">
        <i class="icon-download"></i>
        T·∫£i xu·ªëng
      </button>
    </div>
  </div>

  <!-- A4 CV Preview -->
  <div class="cv-preview" [class.zoomed]="isZoomed">
    <div
      #cvPaper
      class="cv-paper"
      [style.font-family]="designSettings.selectedFont"
      [style.font-size.px]="designSettings.fontSize"
      [style.line-height]="designSettings.lineSpacing"
      [class]="'bg-' + designSettings.selectedBackground"
    >
      <!-- CV Body with Layout Configuration -->
      <div class="cv-body">
        <!-- Grid-based layout: Render rows and columns -->
        <ng-container *ngIf="hasLayoutConfiguration()">
          <div
            *ngFor="let row of getLayoutRows(); trackBy: trackByRowId"
            class="cv-row"
            [attr.data-row-id]="row.id"
          >
            <div class="cv-row-content">
              <!-- Columns within the row -->
              <div
                *ngFor="let column of getRowColumns(row); trackBy: trackByColumnId"
                class="cv-column"
                [attr.data-column-id]="column.id"
                [style.flex]="getColumnWidth(column)"
              >
                <!-- Sections within the column -->
                <ng-container *ngIf="getColumnSections(column).length > 0">
                  <div
                    *ngFor="let sectionId of getColumnSections(column); trackBy: trackBySectionId; let sectionIndex = index"
                    class="cv-section"
                    [attr.data-section-id]="sectionId"
                    [class.hovered]="hoveredSectionId === sectionId"
                    [class.locked]="isSectionLocked(sectionId)"
                    (mouseenter)="onSectionMouseEnter(sectionId)"
                    (mouseleave)="onSectionMouseLeave()"
                  >
                    <!-- Section Hover Controls -->
                    <div *ngIf="showSectionControls(sectionId) && !isSectionLocked(sectionId)" class="section-controls">
                      <button
                        *ngIf="canMoveSectionUp(sectionId, getColumnSections(column))"
                        class="section-control-btn move-up"
                        (click)="onMoveSectionUp(sectionId)"
                        title="Di chuy·ªÉn l√™n"
                      >
                        <i class="icon-arrow-up">üîº</i>
                      </button>
                      <button
                        *ngIf="canMoveSectionDown(sectionId, getColumnSections(column))"
                        class="section-control-btn move-down"
                        (click)="onMoveSectionDown(sectionId)"
                        title="Di chuy·ªÉn xu·ªëng"
                      >
                        <i class="icon-arrow-down">üîΩ</i>
                      </button>
                      <button
                        class="section-control-btn delete"
                        (click)="onDeleteSection(sectionId)"
                        title="X√≥a m·ª•c"
                      >
                        <i class="icon-delete">üóë</i>
                      </button>
                    </div>

                    <!-- Section Content -->
                    <ng-container *ngIf="getSectionById(sectionId) as section">
                    <!-- Section header -->
                    <h3
                      class="cv-section-title"
                      [style.color]="designSettings.selectedColor"
                    >
                      {{ section.name }}
                    </h3>

                    <!-- Section Fields (if defined) -->
                    <div *ngIf="section.fields && section.fields.length > 0" class="cv-section-content">
                      <div
                        *ngFor="let field of section.fields; trackBy: trackByFieldName"
                        class="cv-field-wrapper"
                        [class.field-required]="field.required"
                      >
                        <!-- Field Label (optional) -->
                        <label
                          *ngIf="field.label"
                          class="cv-field-label"
                          [class.required]="field.required"
                        >
                          {{ field.label }}
                          <span *ngIf="field.required" class="required-asterisk">*</span>
                        </label>

                        <!-- Editable Text Fields -->
                        <div
                          *ngIf="isFieldEditable(field)"
                          [attr.data-editable]="true"
                          [attr.data-section-id]="section.id"
                          [attr.data-field-id]="field.name"
                          [attr.data-field-type]="field.type"
                          [class]="getFieldClasses(section, field)"
                          contenteditable="false"
                          [attr.placeholder]="field.placeholder || ''"
                          [textContent]="getFieldValue(field)"
                          (click)="onFieldClick($event, section, field)"
                          (input)="onFieldChange($event, section, field)"
                          (keydown)="onFieldKeyDown($event, section, field)"
                          (blur)="onFieldBlur($event, section, field)"
                          (mouseenter)="onFieldMouseEnter(section, field)"
                          (mouseleave)="onFieldMouseLeave(section, field)"
                        ></div>

                        <!-- Image Fields -->
                        <div
                          *ngIf="field.type === 'image'"
                          class="cv-field cv-field-image"
                          [attr.data-section-id]="section.id"
                          [attr.data-field-id]="field.name"
                          (click)="onImageFieldClick($event, section, field)"
                          style="cursor: pointer"
                        >
                          <div class="image-placeholder" *ngIf="!field.value">
                            <span class="image-icon">üì∑</span>
                            <span class="image-text">{{ field.placeholder || 'Nh·∫•n ƒë·ªÉ t·∫£i ·∫£nh l√™n' }}</span>
                          </div>
                          <img
                            *ngIf="field.value"
                            [src]="field.value"
                            alt="Uploaded image"
                            class="uploaded-image"
                            style="max-width: 100%; height: auto; border-radius: 4px;"
                          />
                        </div>

                        <!-- Non-editable fields (display only) -->
                        <div
                          *ngIf="!isFieldEditable(field) && field.type !== 'image'"
                          class="cv-field cv-field-readonly"
                        >
                          {{ getFieldValue(field) }}
                        </div>
                      </div>
                    </div>

                    <!-- Section content placeholder (if no fields defined) -->
                    <div *ngIf="!section.fields || section.fields.length === 0" class="cv-section-content">
                      <p class="placeholder-text">
                        N·ªôi dung c·ªßa {{ section.name }}
                      </p>
                    </div>
                  </ng-container>
                </div>
                </ng-container>
                
                <!-- Empty column placeholder -->
                <div *ngIf="getColumnSections(column).length === 0" class="cv-column-empty">
                  <p class="empty-column-message">Ch∆∞a c√≥ section n√†o trong c·ªôt n√†y</p>
                </div>
              </div>
            </div>
          </div>
        </ng-container>

        <!-- Fallback: Legacy flat layout (backward compatibility) -->
        <ng-container *ngIf="isLegacyLayout()">
          <div
            *ngFor="let section of getSortedUsedSections()"
            class="cv-section legacy-section"
            [attr.data-section-id]="section.id"
            [class.hovered]="hoveredSectionId === section.id"
            (mouseenter)="onSectionMouseEnter(section.id)"
            (mouseleave)="onSectionMouseLeave()"
          >
            <!-- Section Hover Controls -->
            <div *ngIf="showSectionControls(section.id) && !section.locked" class="section-controls">
              <button
                class="section-control-btn move-up"
                title="Di chuy·ªÉn l√™n"
              >
                <i class="icon-arrow-up">üîº</i>
              </button>
              <button
                class="section-control-btn move-down"
                title="Di chuy·ªÉn xu·ªëng"
              >
                <i class="icon-arrow-down">üîΩ</i>
              </button>
              <button
                class="section-control-btn delete"
                title="X√≥a m·ª•c"
              >
                <i class="icon-delete">üóë</i>
              </button>
            </div>

            <h3
              class="cv-section-title"
              [style.color]="designSettings.selectedColor"
              (click)="onEditableClick($event, section.id)"
            >
              {{ section.name }}
            </h3>

            <div class="cv-section-content">
              <p class="placeholder-text">
                N·ªôi dung c·ªßa {{ section.name }}
              </p>
            </div>
          </div>
        </ng-container>

        <!-- Empty state: No layout configured -->
        <div
          *ngIf="!hasLayoutConfiguration() && !isLegacyLayout()"
          class="cv-empty-state"
        >
          <div class="empty-icon">üìÑ</div>
          <h3>Ch∆∞a c√≥ b·ªë c·ª•c CV</h3>
          <p>S·ª≠ d·ª•ng b·∫£ng ƒëi·ªÅu khi·ªÉn b√™n tr√°i ƒë·ªÉ c·∫•u h√¨nh b·ªë c·ª•c v√† th√™m c√°c m·ª•c v√†o CV c·ªßa b·∫°n.</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Inline Editing Instructions (optional, can be shown as tooltip) -->
  <div class="editing-instructions" *ngIf="activeFieldId">
    <div class="instruction-content">
      <span class="instruction-icon">üí°</span>
      <span class="instruction-text">
        <strong>M·∫πo:</strong> S·ª≠ d·ª•ng Ctrl+B (ƒë·∫≠m), Ctrl+I (nghi√™ng), Ctrl+U (g·∫°ch ch√¢n). Nh·∫•n Esc ƒë·ªÉ ƒë√≥ng.
      </span>
    </div>
  </div>
</div>
